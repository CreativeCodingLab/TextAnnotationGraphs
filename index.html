<html>
<head>

<!-- turns off text selection for svg canvas -->
<style>
svg text {
cursor: default;
-webkit-user-select: none;
-moz-user-select: none;
-ms-user-select: none;
user-select: none;
}

.split-left {width:66.5%; overflow:hidden;}
.split-right {transform:translateX(0) !important;}
.node { cursor: pointer; }
#graph {
    transition:transform 200ms ease;
    transform:translateX(100%);
    width:33%;
    height:100%;
    background:#fafaea;
    position:fixed;
    top:0;
    right:0;
}

</style>

</head>

<body>

<div id="drawing">

</div>
 

<script src="libs/d3.min.js"></script>
<script src="libs/svg.js"></script>
<script src="libs/svg.draggable.js"></script>
<script src="libs/lodash.js"></script>
<script src="libs/chroma.min.js"></script>

<script src="js/GraphLayout.js"></script>
<script src="js/enums.js"></script>
<script src="js/style.js"></script>
<script src="js/annotate.js"></script>
<script src="js/render.js"></script>
<script src="js/interact.js"></script>
<script src="js/utils.js"></script>

<script type="text/javascript">



var debug = true;

var svgWidth = window.innerWidth - 16;
var svgHeight = 1000;



var evenRowsColor = '#efeff4';
var oddRowsColor = '#dddddf';
var rowEdgeColor = 'transparent';

//var draw = SVG('drawing').size('100%', '100%');
var draw = SVG('drawing').size(svgWidth, svgHeight)
            // .attr('viewBox', '0 0 ' + svgWidth + ' ' + svgHeight);

var rowGroup = draw.group();
var groupAllElements;
var linkG, textG, arrowG;

//var gradientDefGroup = draw.defs().group();

var styles = setupStyles(draw); //creates an associative array of whatever styles you want to make use of later

var texts = setupTexts(draw); //creates an associate array of whatever text you want to use. Currently using 'texts.wordText' and 'texts.linkText', and using style, maxHeight, and descent to layout text

var dragElem = null;
var isDragging = false;

var levelpadding = 16;
var /*textpadding */ textpaddingX = 8;//12; //this is the x-padding within each word rect, between the text and the rectangle it's inside of
var textpaddingY = 4;//texts.wordText.maxHeight / 2; //padding above and below text, between text and rectangle it's inside of
var wordpadding = 4; //x padding between the rects containing words
//var topMargin = 0;
var edgepadding = 10; //padding between left side of svg canvas and where first word can be placed, and padding between right side of svg canvas and where last word on a row can fit (before popping over to next row)
var hideLinkLinesPercentage = 3.0; //percentage at which links and arrows are hidden
var hideLinkTextPercentage = 7.0; //percentage at which words are link words are hidden



var handleW = 10;
var handleH = texts.wordText.maxHeight + (textpaddingY * 2);
var handleColor = '#ff0000';
var handleOpacity= 0.1;

//should be able to remove these hardcoded vals - moved this logic to style.js, arrow functions. Looks like intereact.js dragArrow still uses them, should be able to remove...
var arrowH = 5; //9;
var arrowMH = 5; //7; //4
var arrowW = 3; //3

var wordHeight = texts.wordText.maxHeight + (textpaddingY * 2); 
var minWordWidth = getTextWidthAndHeight("i", texts.wordText.style).w + (handleW * 2);


var evenRowsColor_selected = '#cdcdff';
var oddRowsColor_selected = '#bbbbff';
var dragRectSide = 8;
var dragRectMargin = 1;

var rowOffsetX = 0;
var rowOffsetWord = null;
var dragDir = directions.NONE;
var prevX = -1;

var linkStrokeThickness = 1.5;
var linkStrokeColor = '#cc9999';
var linkStrokeOpacity = 1.0;

var linkStrokeThickness_selected = 1.5;
var linkStrokeColor_selected = '#449944';
var linkStrokeOpacity_selected = 1.0;

var attachmentMargin = 0.1; //percentage value

var word2word_strategy = strategies.FARTHEST;
var word2link_strategy = strategies.CLOSEST; 
var link2link_strategy = strategies.CLOSEST; //CLOSEST sometimes causes overlaps - need to be a bit more rigorous when assigning slots - don't assign any slots that have the potential to overlap (when dragged manually)? - or let the buyer beware that this could happen - they can always move out of the way - right now it won't automatically overlap, but won't prevent a user from doing it. 

var rows = []; //list of Row object, each of those has a list of Word objects


// 1. create Words and Links objects (in utils.js) */
var wordObjs = createTestWords(15, 1, 15);

//var linkObjs = createTestLinks(1,1,0); 
var linkObjs = createTestLinks(4,4,4); 

// 2. draw words and boxes around words
drawWords(wordObjs);

// 3. draw each of the links
drawLinks(linkObjs);


 changeSizeOfSVGPanel(window.innerWidth - 16, (rows[rows.length - 1].lineBottom.y() ) + 1);



var prevWidth = svgWidth;
// init objects/listeners...
window.onload = function() {
  var Panel = new GraphLayout();

  function svgResize() {
    var w, widthPercChange; 
    if (Panel.isOpen) {

      svgWidth = (window.innerWidth - 16) * 0.665;

      changeSizeOfSVGPanel(svgWidth, draw.height());

      //draw.size(svgWidth, draw.height());
    }
    else {
      svgWidth = (window.innerWidth - 16)
      changeSizeOfSVGPanel(svgWidth, draw.height());


     //   draw.size(svgWidth, draw.height());

    }
      
    widthPercChange = svgWidth / prevWidth;
    prevWidth = svgWidth;
    //console.log("\nwidthPercChange = " + widthPercChange);


    recalculateRows(widthPercChange); //makes sure that the words fit in the current width, else makes new rows
  
  }

  document.addEventListener('keydown',
    function(e) {
      var key = e.keyCode || e.which;
      // console.log('keycode',key);
      switch(key) {
        case 37:          // left arrow
          if (Panel.isOpen) {
            Panel.close();
            svgResize();
          }
          break;
        case 39:          // right arrow
          if (!Panel.isOpen) {
            Panel.open();
            svgResize();
          }
          Panel.graph(wordObjs.filter(word => word.isSelected));
          break;
        default:
          break;
      }
    }, false);

  function resize() {
    svgResize();
    Panel.resize();
  }

  window.onresize = _.debounce(resize, 300);
}

</script>


</body>
</html>


<html>
<head>

<!-- turns off text selection for svg canvas -->
<style>
body {
  margin:0;
  -moz-osx-font-smoothing:grayscale;
  -webkit-font-smoothing:antialiased;
}

svg text {
  cursor: default;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

#header {
  position:absolute;
  top:0;
  left:0;
  background:#333;
  color:white;
  width:calc( 100% - 20px );
  padding:10px;
}

#drawing {
  margin-top:30px;
}

button {
  background:white;
  border:none;
  outline:none;
}

button.active {
  background:#ff8;
}

.split-left {width:66.5%; overflow:hidden;}
.split-right {transform:translateX(0) !important;}
.node { cursor: pointer; }
#graph {
    transition:transform 200ms ease;
    transform:translateX(100%);
    width:33%;
    height:100%;
    background:#fafaea;
    position:fixed;
    top:0;
    right:0;
}

</style>

</head>

<body>

<div id="header">
  <button id="random">random graph</button>
  <select id="dataset">
    <option>-- select dataset --</option>
    <option>data1</option>
    <option>data2</option>
    <option>paragraph</option>
    <option>passage</option>
  </select>
</div>

<div id="drawing">

</div>


<script src="libs/d3.min.js"></script>
<script src="libs/svg.js"></script>
<script src="libs/svg.draggable.js"></script>
<script src="libs/lodash.js"></script>
<script src="libs/chroma.min.js"></script>

<script src="js/enums.js"></script>
<script src="js/config.js"></script>
<script src="js/parser.js"></script>
<script src="js/GraphLayout.js"></script>
<script src="js/style.js"></script>
<script src="js/annotate.js"></script>
<script src="js/render.js"></script>
<script src="js/interact.js"></script>
<script src="js/utils.js"></script>

<script type="text/javascript">

/* a lot of these global vars should be wrapped eventually */
var draw = SVG('drawing').size(Config.svgWidth, Config.svgHeight);
var rowGroup = draw.group();
var groupAllElements;
var linkG, textG, arrowG;
var dragElem = null;
var isDragging = false;

var styles = setupStyles(draw); //creates an associative array of whatever styles you want to make use of later

var texts = setupTexts(draw); //creates an associate array of whatever text you want to use. Currently using 'texts.wordText' and 'texts.linkText', and using style, maxHeight, and descent to layout text

Config.handleH = texts.wordText.maxHeight + (Config.textPaddingY * 2);
Config.wordHeight = texts.wordText.maxHeight + (Config.textPaddingY * 2); 
Config.minWordWidth = Math.max( getTextWidthAndHeight("i", texts.wordText.style).w + (Config.handleW * 2), getTextWidthAndHeight("i", texts.tagText.style).w + (Config.handleW * 2) );

var rowOffsetX = 0;
var rowOffsetWord = null;
var prevX = -1;

var rows = []; //list of Row object, each of those has a list of Word objects

// 1. create Words and Links objects (in utils.js) */
var wordObjs = createTestWords(4, 10, 10);

//var linkObjs = createTestLinks(3,3,3); 
//var linkObjs = createTestLinks(1,0,0); 
var linkObjs = createTestMultiLinks(1); 

drawWords(wordObjs);
drawLinks(linkObjs);

changeSizeOfSVGPanel(window.innerWidth - 16, (rows[rows.length - 1].lineBottom.y() ) + 1);

window.onload = function() {
  var Panel = new GraphLayout();
  var parser = new Parser();

  var prevWidth = Config.svgWidth;
  function svgResize() {
    var widthPercChange; 
    if (Panel.isOpen) {
      Config.svgWidth = (window.innerWidth - 16) * 0.665;
    }
    else {
      Config.svgWidth = (window.innerWidth - 16)
    }
    changeSizeOfSVGPanel(Config.svgWidth, draw.height());
    widthPercChange = Config.svgWidth / prevWidth;
    prevWidth = Config.svgWidth;
    recalculateRows(widthPercChange); //makes sure that the words fit in the current width, else makes new rows  
  }

  function handleKeyDown(e) {
    var key = e.keyCode || e.which;
    // console.log('keycode',key);
    switch(key) {
      case 37:          // left arrow
        if (Panel.isOpen) {
          Panel.close();
          svgResize();
        }
        break;
      case 39:          // right arrow
        if (!Panel.isOpen) {
          Panel.open();
          svgResize();
        }
        Panel.graph(wordObjs.filter(word => word.isSelected));
        break;
      default:
        break;
    }
  };
  
  function changeDataset() {
    if (this.selectedIndex > 0) {
      parser.readJson(`./data/data${this.selectedIndex}.json`, function() {
        console.log(parser);
        var words = parser.tokens.map((token, i) => new Word(token, i));
        resetDrawing(words, []);
      });
    }
  };

  function resetDrawing(words, links) {
    draw.clear();
    rowGroup = draw.group();
    groupAllElements = linkG = textG = arrowG = undefined;
    dragElem = null;
    isDragging = false;
    rowOffsetX = 0;
    rowOffsetWord = null;
    prevX = -1;

    rows = [];
    wordObjs = words || createTestWords(5, 6, 10);
    linkObjs = links || createTestMultiLinks(1);
    drawWords(wordObjs);
    drawLinks(linkObjs);
    if (Panel.isOpen) { Panel.close(); }
    changeSizeOfSVGPanel(window.innerWidth - 16, (rows[rows.length - 1].lineBottom.y() ) + 1);
  }

  function resize() {
    svgResize();
    Panel.resize();
  }

  document.addEventListener('keydown', handleKeyDown, false);
  document.getElementById('random').onclick = resetDrawing.bind(this, null, null);
  document.getElementById('dataset').onchange = changeDataset;
  window.onresize = _.debounce(resize, 300);

};

</script>


</body>
</html>

